<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.55">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sam Harper">
<meta name="dcterms.date" content="2023-06-14">

<title>25 Years of Multilevel Models in Social Epidemiology</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="ser-mem-paper_files/libs/clipboard/clipboard.min.js"></script>
<script src="ser-mem-paper_files/libs/quarto-html/quarto.js"></script>
<script src="ser-mem-paper_files/libs/quarto-html/popper.min.js"></script>
<script src="ser-mem-paper_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ser-mem-paper_files/libs/quarto-html/anchor.min.js"></script>
<link href="ser-mem-paper_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ser-mem-paper_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ser-mem-paper_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ser-mem-paper_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ser-mem-paper_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">25 Years of Multilevel Models in Social Epidemiology</h1>
<p class="subtitle lead">A Story in Three Acts</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sam Harper </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2023-06-14</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Thanks for the invitation to discuss the recent history of multilevel modeling in social epidemiology. I’d like to do a bit of setting the scene, as my co-presenters are here to provide a lot more of the substantive and methodological discussion. So, a bit of background.</p>
<p>Let’s go back to the early 1990s, filled with baggy clothes and questionable mash-ups of different musical genres.</p>
<p>One of the first papers to explicitly advocate for multilevel analysis in epidemiology was from Von Korff et al.&nbsp;in 1992. Noting the recent development and application of multilevel statistical models in the 1980s in demography, statistics, and education, they made a pitch for epidemiology to take up and use multilevel models, taking care to note that such an exercise depended on having explicit theories for why and how extra-individual factors may affect individual health. It’s also worth noting that their main focus was on the ability of multilevel models to allow for the simultaneous estimating of both individual and contextual factors.</p>
<p>At the same time, a strong set of critiques of the discipline were coming from social epidemiologists, notably Krieger, Schwartz, Pearce and Ezra and Mervyn Susser, arguing that epidemiology’s obsession with individual risk factors and failed behavioral trials were causing us to lose the population perspective that was crucial to past successes.</p>
<p>These critiques found additional support in the conceptual models that were also emerging at this time. Virtually all of these conceptual models for understanding the determinants of health placed some primacy on two things. One, that the traditional, individual-centered focus on epidemiology on risk factors for disease was inadequate for explaining population health and health inequalities. Two, that the process of generating distributions of health and disease involved multiple levels, including communities, neighborhoods, municipalities, states, etc. The development, adoption, and use of multilevel statistical models held enormous promise for highlighting and demonstrating the relevance of these new conceptual models, with the aim to bring back the population perspective.</p>
<p>So, at this time social epidemiology was in some respects primed for adoption of multilevel thinking given the long history of interest in place-based comparative health assessments in the tradition of the discipline’s founders, the idea of communities as dynamic laboratories and, as previously noted, a strong emphasis on the population perspective as a tool to oppose ethe xcessive individualism of biomedicine.</p>
<p>With that background in mind, let’s turn the Act 1 of our short story: The Big Idea. I would argue that there were really two big ideas that helped spur the adoption of multilevel statistical models in social epi. The first was the idea of simultaneous analysis of both individual and contextual factors. Prior to the development of the modern causal inference perspective now prevalent in most training programs, finding “independent” effects via multivariable regression was the goal of many etiologic studies. Early work from Pat O’Campo, Ana Diez-Roux, and George Kaplan in the US (though there were also a number of early studies in Europe as well) mainly focused on mutual adjustment and the search for ‘independent’ ecological or contextual exposures after adjustment for individual-level risk factors.</p>
<p>And it’s hard to overstate the importance to social epidemiology of the early 1997 Science paper by the sociologist Robert Sampson and colleagues reporting that individual-level violent crime outcomes in Chicago were linked to neighborhood level measures of collective efficacy and informal social control. It linked a strong theoretical foundation with detailed field measurements, sophisticated multilevel models, and consideration of mechanisms.</p>
<p>Credit for early adoption and popularization of these methods should also be given to the 1998 paper by Diez-Roux that made a more specific case for adopting multilevel models. It remains a classic paper that laid out core conceptual and methodological issues related to defining contextual exposures, measurement challenges, and models. The majority of the focus remained, however, on the idea of simultaneous statistical adjustment. But she also made it clear that multilevel models were one way to help restore the population perspective to epidemiologic research.</p>
<p>The second ‘Big Idea’ that increased adoption of multilevel models was the issue of income inequality and health. Early ecological studies found that in rich countries population health was more strongly linked to income distribution than average income. By definition, inequality was a contextual measure, since it isn’t a property of individuals. This idea prompted a large literature of multilevel investigations on how inequality might affect health, via relative comparisons, psychosocial effects, social capital, or other channels, a reflection of ideas present in the Science paper by Sampson et al.</p>
<p>Once the statistical issues had been more-or-less well described, much of the methodological discussions in the social epi literature focused on issues related to how to define neighborhoods, boundaries, how to develop, capture, or measure the relevant dimensions of context. As well as issues related whether and how to control for relevant individual-level variables.</p>
<p>By 2001 a systematic review of 25 neighborhood studies found fewer than half actually used multilevel studies, but continued to emphasize that nearly all found some statistically significant associations after controlling for individual factors. Moreover, it maintained the idea that interventions at the contextual level were likely to be useful.</p>
<p>Social epidemiology largely continued down this path, with a series of multilevel tutorials from Juan Merlo that made a case that clustering and decomposing variance into between and within contexts, easily accomplished by random effects models, was a key to helping epidemiology make better decisions about interventions.</p>
<p>This idea had strong pull and by the early 2000s, researchers and public health advocates were making strong arguments that the time for intervening in neighborhoods had come.</p>
<p>Which brings us to Act 2, which I’ll call A Crisis of Confidence.</p>
<p>The US Department of Housing and Urban Development had taken seriously the idea of intervening to change individuals’ exposure to disadvantaged neighborhoods, designing and implementing an expensive trial called ‘Moving to Opportunity’ that randomized more than 4500 poor families to a housing voucher that mandated moving from higher to lower-poverty neighborhoods. The interim results of that trial were published in 2003. The intervention did lead to unconfounded differences in exposure to high-poverty neighborhoods, but the results were decidedly mixed: pretty clearly null effects for mothers on economic outcomes, but some positive and even some negative outcomes for kids, depending on gender and outcome. Like all trials, this one had many limitations, but the lack of transformational outcomes provided neighborhood effects skeptics with some ammunition.</p>
<p>Every story needs a villan (or a hero, depending on your perspective), and in 2004 the social epidemiologist Michael Oakes took up that role by launching a broadside against the neighborhood effects empirical literature, which generated an serious exchange with both Ana Diez-Roux and SV Subramanian, two leading multilevel modeling researchers.</p>
<p>Oakes effectively argued that multilevel modelers were too focused on the uncritical use of mutual adjustment, significance testing and random error, despite the fact that these were not the real problems to be overcome. What were the problems? The inability to tease apart individual and social exposures, endogeneity of neighborhood exposures, model extrapolation and spillover effects.</p>
<p>Meanwhile, the income inequality hypothesis was also having a crisis. Several multilevel papers found limited evidence that inequality was ‘independently’ associated with health, and the literature was highly heterogenous. Our systematic review in 2004 argued that nearly 100 multilevel studies had produced, at best, weak evidence.</p>
<p>Some of these discrepancies were do to explicit modeling choices. A testy exchange in Health Services Research between the economists Mellor and Milyo and Subramanian, Blakely, and Kawachi came to very different conclusions as to the value of whether a fixed or random effects approach was most appropriate for answering the question, with the fixed effects approach resulting in null evidence and random effects showing inequality was correlated with worse health.</p>
<p>By the late 2000s the neighborhood effects literature had matured, but some cracks were evident. Among 86 papers reviewed in 2007 nearly 80% were still using cross-sectional designs and mostly random effects, and among these the findings were inconsistent. And yet, the <em>idea</em> of the promise of multilevel models for revealing how to intervene on contexts remained strong.</p>
<p>Finally, our villain/hero Oakes had effectively given up on the whole project, arguing that we were just not learning much about causal effects of neighborhoods because multilvel studies simply refused to engage critically with the issue of causal identification.</p>
<p>Which brings us now to Act 3: is there ‘A Way Forward’?</p>
<p>Recent years have actually seen a very productive merging of the huge increase in work on formal causal inference and work on multilevel models in social epidemiology. In particular, there has been much more attention focused on the key challenges to identification raised by Oakes and others. This has taken the form of stronger study designs like cluster RCTs and quasi-experiments. Moreover, an emphasis on utilizing longitudinal data to take advantage of individuals moving in and out of neighborhoods, as well as neighborhood changes themselves have tightened the focus on assumptions needed for causal inference. Finally, work on weighting methods to handle time-varying exposures and confounding have helped recent studies to deal with the problem of ‘overcontrolling’ for individual-level factors noted in prior work. All of these developments fit quite well within the framework of multilevel social epidemiology, though I admit are still not the most common approaches</p>
<p>In the early 2010s work by Hong and Raudenbush in education helped to push the methods forward for multilevel time-varying designs, and assumptions for inference were helped by directed acyclic graphs such as this one from Ari Nandi and Ichiro Kawachi. Researchers like Magda Cerda and Maria Glymour were early adopters of this improved work, and there continued to be substantive debates around modeling specifications, again with some controversy regarding the utility (or futility) of random effects models.</p>
<p>The work on causal inference also helped to stimulate a productive discussion regarding the disappointing MTO results. This focused largely on whether the ITT estimates from MTO were adequately answering the right question, or capturing the impact of duration of exposure to disadvantaged neighborhood conditions.</p>
<p>Using a novel design, Sampson, Sharkey and Raudenbush used marginal structural models to demonstrate how one could assess the impact of different durations of exposure to high-poverty neighborhoods, and found stronger effects when incorporating lagged impacts.</p>
<p>Although the positive merging of causal inference and multilevel models pushed the field forward, many studies using these designs found weaker evidence for neighborhood effects on health. Galston and Sharkey reviewed studies with credible causal designs in 2017 and noted decidedly mixed evidence, as well as examples demonstrating problems of self selection and confounding in studies with weaker designs. Nevertheless, they found the evidence was heterogeneous and required keen attention to issues of the context, specific exposures and outcomes for neighborhood studies.</p>
<p>Finally, a word about cluster RCTs. One of the main challenges to the MTO trial was the fact that it changed where individuals lived rather than changing neighborhood conditions. Cluster-level interventions instead focus on changes places, perhaps more in keeping with the original spirit of contextual studies in epidemiology. Recent trials by Branas and colleagues intervening to remediate blighted housing lots in Philadelphia have shown both meaningful and cost-effective impacts on violent crime.</p>
<p>So, where does that leave us? On the whole, the embrace and adoption of multilevel models in social epidemiology has helped to spur innovation in the field: conceptually, methodologically and substantively. Recent work is taking causal inference seriously; however, one might say that the field still has yet to deliver on the big promises of the early papers advocating for multilevel models. Moreover, I would still say the modal neighborhood study remains cross sectional, a design unlikely to help at this point. Regarding the neighborhood effects literature, it seems at this point there is no overarching story, though we do have some strong evidence from high quality designs. This seems less true for adult health than for children, so incorporating a lifecourse perspective regarding duration of exposure is also likely to be fruitful. Finally, although resource intensive and complex, cluster-randomized designs are probably underutilized given the inferential strengths they bring to the table. Thank you.</p>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>